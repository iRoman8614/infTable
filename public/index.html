<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Virtualized Table - Working Version</title>
</head>
<body>
<h1>Виртуализированная таблица</h1>

<!-- Встроенные провайдеры -->
<script>
  console.log('[HTML] Установка провайдеров...');

  // === ПРОВАЙДЕР ЗАГОЛОВКОВ ===
  window.HeadersProvider = function() {
    console.log('[HeadersProvider] Вызов функции провайдера');

    return {
      headers: [
        {
          id: "factory1",
          parentId: null,
          name: "Завод №1 'Металлург'",
          metadata: {
            color: "#343434",
            workCount: 150
          }
        },
        {
          id: "workshop1",
          parentId: "factory1",
          name: "Цех сборки №1",
          metadata: {
            color: "#4caf50",
            workCount: 45
          }
        },
        {
          id: "line1",
          parentId: "workshop1",
          name: "Линия А",
          metadata: {
            color: "#ff9800",
            workCount: 15
          }
        },
        {
          id: "station1",
          parentId: "line1",
          name: "Станция 1",
          metadata: {
            color: "#f44336",
            workCount: 3
          }
        },
        {
          id: "station2",
          parentId: "line1",
          name: "Станция 2",
          metadata: {
            color: "#f44336",
            workCount: 4
          }
        },
        {
          id: "station3",
          parentId: "line1",
          name: "Станция 3",
          metadata: {
            color: "#f44336",
            workCount: 5
          }
        },
        {
          id: "line2",
          parentId: "workshop1",
          name: "Линия Б",
          metadata: {
            color: "#ff9800",
            workCount: 12
          }
        },
        {
          id: "station4",
          parentId: "line2",
          name: "Станция 4",
          metadata: {
            color: "#f44336",
            workCount: 2
          }
        },
        {
          id: "station5",
          parentId: "line2",
          name: "Станция 5",
          metadata: {
            color: "#f44336",
            workCount: 3
          }
        },
        {
          id: "workshop2",
          parentId: "factory1",
          name: "Цех механообработки",
          metadata: {
            color: "#4caf50",
            workCount: 65
          }
        },
        {
          id: "section1",
          parentId: "workshop2",
          name: "Участок токарных работ",
          metadata: {
            color: "#9c27b0",
            workCount: 25
          }
        },
        {
          id: "machine1",
          parentId: "section1",
          name: "Станок ЧПУ-1",
          metadata: {
            color: "#795548",
            workCount: 1
          }
        },
        {
          id: "machine2",
          parentId: "section1",
          name: "Станок ЧПУ-2",
          metadata: {
            color: "#795548",
            workCount: 1
          }
        },
        {
          id: "factory2",
          parentId: null,
          name: "Завод №2 'Электрон'",
          metadata: {
            color: "#3f51b5",
            workCount: 120
          }
        },
        {
          id: "workshop3",
          parentId: "factory2",
          name: "Цех печатных плат",
          metadata: {
            color: "#00bcd4",
            workCount: 35
          }
        },
        {
          id: "pcb_line1",
          parentId: "workshop3",
          name: "Линия ПП-1",
          metadata: {
            color: "#e91e63",
            workCount: 8
          }
        },
        {
          id: "pcb_line2",
          parentId: "workshop3",
          name: "Линия ПП-2",
          metadata: {
            color: "#e91e63",
            workCount: 6
          }
        }
      ]
    };
  };

  // === ПРОВАЙДЕР ДАННЫХ ===
  window.customDataProvider = async function(startDate, days, leafNodes) {
    console.log(`[DataProvider] Загрузка: ${startDate}, дней: ${days}, узлов: ${leafNodes.length}`);

    // Имитация задержки
    await new Promise(resolve => setTimeout(resolve, 100));

    const batchData = [];
    const statuses = ["М", "О", "П", "ПР", "Р"];

    // Парсинг даты
    const [day, month, year] = startDate.split('.').map(Number);
    const startDateObj = new Date(year, month - 1, day);

    for (let i = 0; i < days; i++) {
      const currentDate = new Date(startDateObj);
      currentDate.setDate(startDateObj.getDate() + i);

      const dateStr = currentDate.toLocaleDateString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });

      const dayData = {
        date: dateStr,
        timestamp: Date.now()
      };

      leafNodes.forEach(node => {
        dayData[node.id] = statuses[Math.floor(Math.random() * statuses.length)];
      });

      batchData.push(dayData);
    }

    return { data: batchData };
  };

  // === ОБРАБОТЧИК КЛИКОВ ===
  window.handleCellClick = function(cellData) {
    console.log('[ClickHandler] Клик по ячейке:', cellData);
    console.log(`Дата: ${cellData.date}, Узел: ${cellData.node?.name}, Значение: ${cellData.value}`);
  };

  // Создаем алиасы для совместимости
  // window.hp = window.HeadersProvider;
  window.hp = function() {
    console.log('[HeadersProvider] Вызов функции провайдера');

    return {
      headers: [
        {
          id: "factory1",
          parentId: null,
          name: "Завод №1 'Металлург'",
          metadata: {
            color: "#343434",
            workCount: 150
          }
        },
        {
          id: "workshop1",
          parentId: "factory1",
          name: "Цех сборки №1",
          metadata: {
            color: "#4caf50",
            workCount: 45
          }
        },
        {
          id: "line1",
          parentId: "workshop1",
          name: "Линия А",
          metadata: {
            color: "#ff9800",
            workCount: 15
          }
        },
        {
          id: "station1",
          parentId: "line1",
          name: "Станция 1",
          metadata: {
            color: "#f44336",
            workCount: 3
          }
        },
        {
          id: "station2",
          parentId: "line1",
          name: "Станция 2",
          metadata: {
            color: "#f44336",
            workCount: 4
          }
        },
        {
          id: "station3",
          parentId: "line1",
          name: "Станция 3",
          metadata: {
            color: "#f44336",
            workCount: 5
          }
        },
        {
          id: "line2",
          parentId: "workshop1",
          name: "Линия Б",
          metadata: {
            color: "#ff9800",
            workCount: 12
          }
        },
        {
          id: "station4",
          parentId: "line2",
          name: "Станция 4",
          metadata: {
            color: "#f44336",
            workCount: 2
          }
        },
        {
          id: "station5",
          parentId: "line2",
          name: "Станция 5",
          metadata: {
            color: "#f44336",
            workCount: 3
          }
        },
        {
          id: "workshop2",
          parentId: "factory1",
          name: "Цех механообработки",
          metadata: {
            color: "#4caf50",
            workCount: 65
          }
        },
        {
          id: "section1",
          parentId: "workshop2",
          name: "Участок токарных работ",
          metadata: {
            color: "#9c27b0",
            workCount: 25
          }
        },
        {
          id: "machine1",
          parentId: "section1",
          name: "Станок ЧПУ-1",
          metadata: {
            color: "#795548",
            workCount: 1
          }
        },
        {
          id: "machine2",
          parentId: "section1",
          name: "Станок ЧПУ-2",
          metadata: {
            color: "#795548",
            workCount: 1
          }
        },
        {
          id: "factory2",
          parentId: null,
          name: "Завод №2 'Электрон'",
          metadata: {
            color: "#3f51b5",
            workCount: 120
          }
        },
        {
          id: "workshop3",
          parentId: "factory2",
          name: "Цех печатных плат",
          metadata: {
            color: "#00bcd4",
            workCount: 35
          }
        },
        {
          id: "pcb_line1",
          parentId: "workshop3",
          name: "Линия ПП-1",
          metadata: {
            color: "#e91e63",
            workCount: 8
          }
        },
        {
          id: "pcb_line2",
          parentId: "workshop3",
          name: "Линия ПП-2",
          metadata: {
            color: "#e91e63",
            workCount: 6
          }
        }
      ]
    };
  };
  window.dp = window.customDataProvider;

  console.log('[HTML] Провайдеры установлены:');
  console.log('- HeadersProvider:', typeof window.HeadersProvider);
  console.log('- customDataProvider:', typeof window.customDataProvider);
  console.log('- handleCellClick:', typeof window.handleCellClick);

  // Тестируем провайдер заголовков
  try {
    const testHeaders = window.HeadersProvider();
    console.log(`[HTML] Тест провайдера: ${testHeaders.headers.length} заголовков`);
  } catch (error) {
    console.error('[HTML] Ошибка в провайдере заголовков:', error);
  }
</script>

<virtualized-table
        header-provider-name="HeadersProvider"
        data-provider-name="customDataProvider"
        on-cell-click-handler="handleCellClick"
        max-width="100%"
        max-height="600px"
        scroll-batch-size="7"
        debug="true">
</virtualized-table>

<!-- Загрузка компонента -->
<script>
  console.log('[HTML] Загрузка компонента таблицы...');

  const script = document.createElement('script');
  script.src = '../dist/virtualized-table.js';

  script.onload = function() {
    console.log('[HTML] ✅ Компонент таблицы загружен');

    // Проверяем регистрацию через задержку
    setTimeout(() => {
      const registered = customElements.get('virtualized-table');
      if (registered) {
        console.log('[HTML] ✅ Web Component зарегистрирован');
        console.log('[HTML] 🎯 Таблица должна отобразиться с правильными заголовками');
      } else {
        console.error('[HTML] ❌ Web Component НЕ зарегистрирован');
      }
    }, 500);
  };

  script.onerror = function() {
    console.error('[HTML] ❌ Ошибка загрузки компонента');
    console.log('[HTML] Попробуйте другие пути:');
    console.log('- /dist/virtualized-table.js');
    console.log('- ./dist/virtualized-table.js');
  };

  document.head.appendChild(script);
</script>

<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background-color: #f5f5f5;
  }
  h1 {
    color: #333;
    margin-bottom: 20px;
  }
  virtualized-table {
    background: white;
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
</style>
</body>
</html>