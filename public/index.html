<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Виртуализированная таблица</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }
    virtualized-table {
      background: white;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

<virtualized-table
        max-width="100%"
        max-height="600px"
        scroll-batch-size="14"
        debug="true">
</virtualized-table>

<script>
  // ВАЖНО: Провайдеры должны быть определены ДО загрузки компонента

  // 1. Провайдер заголовков
  window.hp = async function() {
    console.log('[HP] Загрузка заголовков...');
    await new Promise(resolve => setTimeout(resolve, 100));

    return {
      "headers": [
        {
          "id": "factory1",
          "parentId": null,
          "type": "node",
          "name": "Завод №1 'Металлург'",
          "metadata": {
            "color": "#343434",
            "tooltip": "Основной производственный комплекс",
            "workCount": 150
          }
        },
        {
          "id": "workshop1",
          "parentId": "factory1",
          "type": "assembly",
          "name": "Цех сборки №1",
          "metadata": {
            "color": "#4caf50",
            "tooltip": "Основной сборочный цех",
            "workCount": 45
          }
        },
        {
          "id": "line1",
          "parentId": "workshop1",
          "type": "component",
          "name": "Линия А",
          "metadata": {
            "color": "#ff9800",
            "tooltip": "Автоматизированная линия сборки",
            "workCount": 15
          }
        },
        {
          "id": "station1",
          "parentId": "line1",
          "type": "component",
          "name": "Станция 1",
          "metadata": {
            "color": "#f44336",
            "tooltip": "Начальная станция сборки",
            "workCount": 3
          }
        },
        {
          "id": "station2",
          "parentId": "line1",
          "type": "component",
          "name": "Станция 2",
          "metadata": {
            "color": "#f44336",
            "tooltip": "Промежуточная станция",
            "workCount": 4
          }
        },
        {
          "id": "station3",
          "parentId": "line1",
          "type": "component",
          "name": "Станция 3",
          "metadata": {
            "color": "#f44336",
            "tooltip": "Финальная станция",
            "workCount": 5
          }
        },
        {
          "id": "station4",
          "parentId": "line1",
          "type": "component",
          "name": "Станция 4",
          "metadata": {
            "color": "#9c27b0",
            "tooltip": "Контрольная станция",
            "workCount": 2
          }
        },
        {
          "id": "station5",
          "parentId": "line1",
          "type": "component",
          "name": "Станция 5",
          "metadata": {
            "color": "#795548",
            "tooltip": "Упаковочная станция",
            "workCount": 3
          }
        }
      ]
    };
  };

  // 2. Провайдер данных с диагностикой
  window.dp = async function(startDate, direction, batchSize) {
    console.log('=== [DP] ВЫЗОВ ПРОВАЙДЕРА ДАННЫХ ===');
    console.log(`[DP] startDate: ${startDate}`);
    console.log(`[DP] direction: ${direction}`);
    console.log(`[DP] batchSize: ${batchSize}`);

    const data = {
      "data": [
        {
          "date": "27.09.2025",
          "columns": [
            {
              "headerId": "station1",
              "value": "М",
              "rowspan": 7,
              "color": "#ffeb3b",
              "draggable": true
            },
            {
              "headerId": "station2",
              "value": "Р",
              "color": "black",
              "draggable": true
            },
            {
              "headerId": "station3",
              "value": "П",
              "color": "#e91e63",
              "draggable": true
            },
            {
              "headerId": "station4",
              "value": "Р",
              "color": "#9c27b0",
              "draggable": true
            },
            {
              "headerId": "station5",
              "value": "П",
              "color": "#795548",
              "draggable": true
            }
          ]
        },
        {
          "date": "28.09.2025",
          "columns": [
            {
              "headerId": "station2",
              "value": "П",
              "color": "#ffeb3b",
              "draggable": true
            },
            {
              "headerId": "station3",
              "value": "М",
              "draggable": false
            },
            {
              "headerId": "station4",
              "value": "О",
              "draggable": false
            },
            {
              "headerId": "station5",
              "value": "П",
              "draggable": false
            }
          ]
        },
        {
          "date": "29.09.2025",
          "columns": [
            {
              "headerId": "station2",
              "value": "ПР",
              "color": "blue",
              "draggable": true
            },
            {
              "headerId": "station3",
              "value": "П",
              "draggable": true
            },
            {
              "headerId": "station4",
              "value": "М",
              "draggable": true
            },
            {
              "headerId": "station5",
              "value": "О"
            }
          ]
        },
        {
          "date": "30.09.2025",
          "columns": [
            {
              "headerId": "station2",
              "value": "О",
              "color": "orange",
              "draggable": true
            },
            {
              "headerId": "station3",
              "value": "Р"
            },
            {
              "headerId": "station4",
              "value": "М"
            },
            {
              "headerId": "station5",
              "value": "Р"
            }
          ]
        },
        {
          "date": "01.10.2025",
          "columns": [
            {
              "headerId": "station2",
              "value": "М",
              "color": "black",
              "draggable": true
            },
            {
              "headerId": "station3",
              "value": "П"
            },
            {
              "headerId": "station4",
              "value": "Р"
            },
            {
              "headerId": "station5",
              "value": "П"
            }
          ]
        },
        {
          "date": "02.10.2025",
          "columns": [
            {
              "headerId": "station2",
              "value": "О",
              "color": "white",
              "draggable": true
            },
            {
              "headerId": "station3",
              "value": "Р"
            },
            {
              "headerId": "station4",
              "value": "П",
              "rowspan": 5,
              "color": "#4caf50"
            },
            {
              "headerId": "station5",
              "value": "Р"
            }
          ]
        },
        {
          "date": "03.10.2025",
          "columns": [
            {
              "headerId": "station2",
              "value": "П",
              "color": "#ffeb3b",
              "draggable": true
            },
            {
              "headerId": "station3",
              "value": "Р"
            },
            {
              "headerId": "station5",
              "value": "Р"
            }
          ]
        },
        {
          "date": "04.10.2025",
          "columns": [
            {
              "headerId": "station1",
              "value": "П"
            },
            {
              "headerId": "station2",
              "value": "М"
            },
            {
              "headerId": "station3",
              "value": "Р"
            },
            {
              "headerId": "station5",
              "value": "Р"
            }
          ]
        },
        {
          "date": "05.10.2025",
          "columns": [
            {
              "headerId": "station1",
              "value": "Р",
              "draggable": true,
              "colspan": 3,
              "color": "#00bcd4"
            },
            {
              "headerId": "station5",
              "value": "Р"
            }
          ]
        },
        {
          "date": "06.10.2025",
          "columns": [
            {
              "headerId": "station1",
              "value": "П"
            },
            {
              "headerId": "station2",
              "value": "М"
            },
            {
              "headerId": "station3",
              "value": "Р"
            },
            {
              "headerId": "station5",
              "value": "Р"
            }
          ]
        },
        {
          "date": "07.10.2025",
          "columns": [
            {
              "headerId": "station1",
              "value": "П"
            },
            {
              "headerId": "station2",
              "value": "М"
            },
            {
              "headerId": "station3",
              "value": "Р"
            },
            {
              "headerId": "station4",
              "value": "П"
            },
            {
              "headerId": "station5",
              "value": "Р"
            }
          ]
        }
      ]
    };

    const jsonString = JSON.stringify(data);
    console.log(`[DP] Возвращаем ${data.data.length} строк данных`);
    console.log('[DP] Первые 200 символов:', jsonString.substring(0, 200));

    return jsonString;
  };

  // 3. Проверяем что провайдеры определены
  console.log('[HTML] Провайдеры определены:');
  console.log('  window.hp:', typeof window.hp);
  console.log('  window.dp:', typeof window.dp);

  // 4. Загрузка компонента
  const script = document.createElement('script');
  script.src = '../dist/virtualized-table.js';

  script.onload = function() {
    console.log('[HTML] ✅ Компонент загружен успешно');

    // Ждем инициализацию API
    const checkAPI = () => {
      if (typeof window.VirtualizedTableAPI !== 'undefined') {
        console.log('[HTML] ✅ VirtualizedTableAPI готов');

        // Проверяем состояние провайдеров
        const state = window.VirtualizedTableAPI.getState();
        console.log('[HTML] Состояние провайдеров:', {
          hasDataProvider: state.hasDataProvider,
          hasHeaderProvider: state.hasHeaderProvider,
          initialized: state.initialized,
          loading: state.loading
        });

        // Если провайдеры не подключились автоматически, подключаем вручную
        if (!state.hasDataProvider) {
          console.log('[HTML] ⚠️ Провайдер данных не найден, регистрируем вручную');
          window.VirtualizedTableAPI.setDataProvider(window.dp);
        }

        if (!state.hasHeaderProvider) {
          console.log('[HTML] ⚠️ Провайдер заголовков не найден, регистрируем вручную');
          window.VirtualizedTableAPI.setHeaderProvider(window.hp);
        }

        // Устанавливаем обработчик двойного клика
        window.VirtualizedTableAPI.setOnCellDoubleClick((cellDataJsonString, event) => {
          console.log('[HTML] ===== ДВОЙНОЙ КЛИК =====');
          console.log('[HTML] Тип данных:', typeof cellDataJsonString);
          console.log('[HTML] JSON строка:', cellDataJsonString);

          try {
            const cellData = JSON.parse(cellDataJsonString);
            console.log('[HTML] Распарсенный объект:', cellData);
            console.log('[HTML] Дата:', cellData.date);
            console.log('[HTML] Узел:', cellData.nodeId);
            console.log('[HTML] Значение:', cellData.value);
          } catch (e) {
            console.error('[HTML] Ошибка парсинга:', e);
          }
        });

        // Устанавливаем обработчик перемещения (DnD)
        window.VirtualizedTableAPI.setOnCellMove((moveDataJsonString) => {
          console.log('[HTML] ===== DRAG & DROP =====');
          console.log('[HTML] Тип данных:', typeof moveDataJsonString);
          console.log('[HTML] JSON строка:', moveDataJsonString);

          try {
            const moveData = JSON.parse(moveDataJsonString);
            console.log('[HTML] Распарсенный объект:', moveData);
            console.log('[HTML] Из:', moveData.fromDate, moveData.fromNodeId);
            console.log('[HTML] В:', moveData.toDate, moveData.toNodeId);
            console.log('[HTML] Значение:', moveData.value);
          } catch (e) {
            console.error('[HTML] Ошибка парсинга:', e);
          }
        });

        // Принудительно обновляем viewport через 500мс
        setTimeout(() => {
          console.log('[HTML] Принудительное обновление viewport...');
          window.VirtualizedTableAPI.refreshViewport();

          // Проверяем состояние после обновления
          const finalState = window.VirtualizedTableAPI.getState();
          console.log('[HTML] Финальное состояние:', finalState);
        }, 500);

      } else {
        console.log('[HTML] Ожидание VirtualizedTableAPI...');
        setTimeout(checkAPI, 100);
      }
    };

    checkAPI();
  };

  script.onerror = function() {
    console.error('[HTML] ❌ Ошибка загрузки компонента');
    alert('Не удалось загрузить файл virtualized-table.js');
  };

  document.head.appendChild(script);

  // 5. Глобальные команды для тестирования в консоли
  window.testDP = function() {
    console.log('=== ТЕСТ ПРОВАЙДЕРА ДАННЫХ ===');
    return window.dp('29.09.2025', 'down', 7);
  };

  window.testHP = function() {
    console.log('=== ТЕСТ ПРОВАЙДЕРА ЗАГОЛОВКОВ ===');
    return window.hp();
  };

  console.log('[HTML] Для тестирования используйте:');
  console.log('  testDP() - проверить провайдер данных');
  console.log('  testHP() - проверить провайдер заголовков');
  console.log('  VirtualizedTableAPI.getState() - состояние таблицы');
  console.log('  VirtualizedTableAPI.refreshViewport() - обновить viewport');
</script>

</body>
</html>