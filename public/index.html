<!--<!DOCTYPE html>-->
<!--<html lang="ru">-->
<!--<head>-->
<!--  <meta charset="utf-8" />-->
<!--  <meta name="viewport" content="width=device-width, initial-scale=1" />-->
<!--  <title>Простая виртуализированная таблица</title>-->
<!--</head>-->
<!--<body>-->
<!--<h1>Простая виртуализированная таблица</h1>-->

<!--<virtualized-table-->
<!--        max-width="100%"-->
<!--        max-height="600px"-->
<!--        scroll-batch-size="7"-->
<!--        debug="true">-->
<!--</virtualized-table>-->

<!--<script>-->
<!--  // 1. Провайдер заголовков (hp) - вызывается только при инициализации-->
<!--  window.hp = function() {-->
<!--    console.log('[HP] Загрузка заголовков');-->
<!--    return {-->
<!--      headers: [-->
<!--        {-->
<!--          "id": "factory1",-->
<!--          "parentId": null,-->
<!--          "type": "node",-->
<!--          "name": "Завод №1 'Металлург'",-->
<!--          "metadata": {-->
<!--            "color": "#343434",-->
<!--            "tooltip": "Основной производственный комплекс",-->
<!--            "workCount": 150-->
<!--          }-->
<!--        },-->
<!--        {-->
<!--          "id": "workshop1",-->
<!--          "parentId": "factory1",-->
<!--          "type": "assembly",-->
<!--          "name": "Цех сборки №1",-->
<!--          "metadata": {-->
<!--            "color": "#4caf50",-->
<!--            "tooltip": "Основной сборочный цех",-->
<!--            "workCount": 45-->
<!--          }-->
<!--        },-->
<!--        {-->
<!--          "id": "line1",-->
<!--          "parentId": "workshop1",-->
<!--          "type": "component",-->
<!--          "name": "Линия А",-->
<!--          "metadata": {-->
<!--            "color": "#ff9800",-->
<!--            "tooltip": "Автоматизированная линия сборки",-->
<!--            "workCount": 15-->
<!--          }-->
<!--        },-->
<!--        {-->
<!--          "id": "station1",-->
<!--          "parentId": "line1",-->
<!--          "type": "component",-->
<!--          "name": "Станция 1",-->
<!--          "metadata": {-->
<!--            "color": "#f44336",-->
<!--            "tooltip": "Начальная станция сборки",-->
<!--            "workCount": 3-->
<!--          }-->
<!--        },-->
<!--        {-->
<!--          "id": "station2",-->
<!--          "parentId": "line1",-->
<!--          "type": "component",-->
<!--          "name": "Станция 2",-->
<!--          "metadata": {-->
<!--            "color": "#f44336",-->
<!--            "tooltip": "Промежуточная станция",-->
<!--            "workCount": 4-->
<!--          }-->
<!--        },-->
<!--        {-->
<!--          "id": "station3",-->
<!--          "parentId": "line1",-->
<!--          "type": "component",-->
<!--          "name": "Станция 3",-->
<!--          "metadata": {-->
<!--            "color": "#f44336",-->
<!--            "tooltip": "Финальная станция",-->
<!--            "workCount": 5-->
<!--          }-->
<!--        },-->
<!--        {-->
<!--          "id": "line2",-->
<!--          "parentId": "workshop1",-->
<!--          "type": "component",-->
<!--          "name": "Линия Б",-->
<!--          "metadata": {-->
<!--            "color": "#ff9800",-->
<!--            "tooltip": "Полуавтоматическая линия",-->
<!--            "workCount": 12-->
<!--          }-->
<!--        },-->
<!--        {-->
<!--          "id": "station4",-->
<!--          "parentId": "line2",-->
<!--          "type": "component",-->
<!--          "name": "Станция 4",-->
<!--          "metadata": {-->
<!--            "color": "#f44336",-->
<!--            "tooltip": "Контрольная станция",-->
<!--            "workCount": 2-->
<!--          }-->
<!--        },-->
<!--        {-->
<!--          "id": "station5",-->
<!--          "parentId": "line2",-->
<!--          "type": "component",-->
<!--          "name": "Станция 5",-->
<!--          "metadata": {-->
<!--            "color": "#f44336",-->
<!--            "tooltip": "Упаковочная станция",-->
<!--            "workCount": 3-->
<!--          }-->
<!--        },-->
<!--        {-->
<!--          "id": "workshop2",-->
<!--          "parentId": "factory1",-->
<!--          "type": "assembly",-->
<!--          "name": "Цех механообработки",-->
<!--          "metadata": {-->
<!--            "color": "#4caf50",-->
<!--            "tooltip": "Цех механической обработки деталей",-->
<!--            "workCount": 65-->
<!--          }-->
<!--        },-->
<!--        {-->
<!--          "id": "section1",-->
<!--          "parentId": "workshop2",-->
<!--          "type": "component",-->
<!--          "name": "Участок токарных работ",-->
<!--          "metadata": {-->
<!--            "color": "#9c27b0",-->
<!--            "tooltip": "Участок токарной обработки",-->
<!--            "workCount": 25-->
<!--          }-->
<!--        },-->
<!--        {-->
<!--          "id": "machine1",-->
<!--          "parentId": "section1",-->
<!--          "type": "component",-->
<!--          "name": "Станок ЧПУ-1",-->
<!--          "metadata": {-->
<!--            "color": "#795548",-->
<!--            "tooltip": "Токарный станок с ЧПУ",-->
<!--            "workCount": 1-->
<!--          }-->
<!--        },-->
<!--        {-->
<!--          "id": "machine2",-->
<!--          "parentId": "section1",-->
<!--          "type": "component",-->
<!--          "name": "Станок ЧПУ-2",-->
<!--          "metadata": {-->
<!--            "color": "#795548",-->
<!--            "tooltip": "Фрезерный станок с ЧПУ",-->
<!--            "workCount": 1-->
<!--          }-->
<!--        },-->
<!--        {-->
<!--          "id": "factory2",-->
<!--          "parentId": null,-->
<!--          "type": "node",-->
<!--          "name": "Завод №2 'Электрон'",-->
<!--          "metadata": {-->
<!--            "color": "#3f51b5",-->
<!--            "tooltip": "Завод электронных компонентов",-->
<!--            "workCount": 120-->
<!--          }-->
<!--        },-->
<!--        {-->
<!--          "id": "workshop3",-->
<!--          "parentId": "factory2",-->
<!--          "type": "assembly",-->
<!--          "name": "Цех печатных плат",-->
<!--          "metadata": {-->
<!--            "color": "#00bcd4",-->
<!--            "tooltip": "Производство печатных плат",-->
<!--            "workCount": 35-->
<!--          }-->
<!--        },-->
<!--        {-->
<!--          "id": "pcb_line1",-->
<!--          "parentId": "workshop3",-->
<!--          "type": "component",-->
<!--          "name": "Линия ПП-1",-->
<!--          "metadata": {-->
<!--            "color": "#e91e63",-->
<!--            "tooltip": "Линия производства печатных плат",-->
<!--            "workCount": 8-->
<!--          }-->
<!--        },-->
<!--        {-->
<!--          "id": "pcb_line2",-->
<!--          "parentId": "workshop3",-->
<!--          "type": "component",-->
<!--          "name": "Линия ПП-2",-->
<!--          "metadata": {-->
<!--            "color": "#e91e63",-->
<!--            "tooltip": "Линия производства сложных плат",-->
<!--            "workCount": 6-->
<!--          }-->
<!--        }-->
<!--      ]-->
<!--    };-->
<!--  };-->

<!--  // 2. Провайдер данных (dp) - все ячейки 'М' (зелёные)-->
<!--  window.dp = async function(startDate, days, leafNodes) {-->
<!--    console.log(`[DP] Запрос: ${startDate}, дней: ${days}, узлов: ${leafNodes.length}`);-->

<!--    // Имитация задержки-->
<!--    await new Promise(resolve => setTimeout(resolve, 100));-->

<!--    const data = [];-->
<!--    const [day, month, year] = startDate.split('.').map(Number);-->
<!--    const startDateObj = new Date(year, month - 1, day);-->

<!--    for (let i = 0; i < days; i++) {-->
<!--      const currentDate = new Date(startDateObj);-->
<!--      currentDate.setDate(startDateObj.getDate() + i);-->

<!--      const dateStr = currentDate.toLocaleDateString('ru-RU', {-->
<!--        day: '2-digit',-->
<!--        month: '2-digit',-->
<!--        year: 'numeric'-->
<!--      });-->

<!--      const dayData = { date: dateStr };-->

<!--      // Все ячейки заполняем 'М' (зелёные)-->
<!--      leafNodes.forEach(node => {-->
<!--        dayData[node.id] = 'М';-->
<!--      });-->

<!--      data.push(dayData);-->
<!--    }-->

<!--    console.log(`[DP] Возвращено ${data.length} записей`);-->
<!--    return { data };-->
<!--  };-->

<!--  // 3. Обработчик кликов - вывод в консоль-->
<!--  window.onTableCellClick = function(cellData) {-->
<!--    console.log(`[КЛИК] Дата: ${cellData.date}, ID столбца: ${cellData.nodeId || cellData.node?.id}`);-->
<!--  };-->

<!--  // Загрузка компонента-->
<!--  const script = document.createElement('script');-->
<!--  script.src = '../dist/virtualized-table.js';-->

<!--  script.onload = function() {-->
<!--    setTimeout(() => {-->
<!--      if (customElements.get('virtualized-table')) {-->
<!--        console.log('[HTML] ✅ Компонент загружен успешно');-->
<!--      } else {-->
<!--        console.error('[HTML] ❌ Компонент не зарегистрирован');-->
<!--      }-->
<!--    }, 500);-->
<!--  };-->

<!--  script.onerror = function() {-->
<!--    console.error('[HTML] ❌ Ошибка загрузки компонента');-->
<!--  };-->

<!--  document.head.appendChild(script);-->
<!--</script>-->

<!--<style>-->
<!--  body {-->
<!--    font-family: Arial, sans-serif;-->
<!--    margin: 20px;-->
<!--    background-color: #f5f5f5;-->
<!--  }-->
<!--  h1 {-->
<!--    color: #333;-->
<!--    margin-bottom: 20px;-->
<!--  }-->
<!--  virtualized-table {-->
<!--    background: white;-->
<!--    border-radius: 4px;-->
<!--    box-shadow: 0 2px 4px rgba(0,0,0,0.1);-->
<!--  }-->
<!--</style>-->
<!--</body>-->
<!--</html>-->

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Async виртуализированная таблица (локально)</title>
</head>
<body>
<h1>Async виртуализированная таблица</h1>

<div style="background: #e8f4fd; padding: 10px; border-radius: 4px; margin-bottom: 20px; font-size: 14px;">
  <strong>Локальная версия:</strong> Все провайдеры async с новым форматом данных
</div>

<virtualized-table
        max-width="100%"
        max-height="600px"
        scroll-batch-size="7"
        debug="true">
</virtualized-table>

<script>
  // 1. Async провайдер заголовков (hp)
  window.hp = async function() {
    console.log('[ASYNC HP] Загрузка заголовков...');

    // Имитация async загрузки
    await new Promise(resolve => setTimeout(resolve, 100));

    console.log('[ASYNC HP] Заголовки загружены');
    return {
      headers: [
        { id: "factory1", parentId: null, name: "Завод №1", metadata: { color: "#343434", workCount: 150 } },
        { id: "workshop1", parentId: "factory1", name: "Цех 1", metadata: { color: "#4caf50", workCount: 45 } },
        { id: "line1", parentId: "workshop1", name: "Линия А", metadata: { color: "#ff9800", workCount: 15 } },
        { id: "station1", parentId: "line1", name: "Станция 1", metadata: { color: "#f44336", workCount: 3 } },
        { id: "station2", parentId: "line1", name: "Станция 2", metadata: { color: "#f44336", workCount: 4 } },
        { id: "station3", parentId: "line1", name: "Станция 3", metadata: { color: "#f44336", workCount: 5 } },
        { id: "line2", parentId: "workshop1", name: "Линия Б", metadata: { color: "#ff9800", workCount: 12 } },
        { id: "station4", parentId: "line2", name: "Станция 4", metadata: { color: "#f44336", workCount: 2 } },
        { id: "station5", parentId: "line2", name: "Станция 5", metadata: { color: "#f44336", workCount: 3 } }
      ]
    };
  };

  // 2. Async провайдер данных (dp) - новый API с направлением
  window.dp = async function(startDate, direction, batchSize) {
    console.log(`[ASYNC DP] Запрос: ${startDate}, направление: ${direction}, размер: ${batchSize}`);

    // Имитация задержки
    await new Promise(resolve => setTimeout(resolve, 200));

    const data = [];
    const [day, month, year] = startDate.split('.').map(Number);
    const startDateObj = new Date(Date.UTC(year, month - 1, day));

    // Определяем диапазон дат в зависимости от направления
    let startDay = 0;
    let endDay = batchSize;

    if (direction === 'backward') {
      startDay = -batchSize;
      endDay = 0;
    }

    // Генерируем данные в новом формате
    for (let i = startDay; i < endDay; i++) {
      const currentDate = new Date(startDateObj);
      currentDate.setUTCDate(startDateObj.getUTCDate() + i);

      const dateStr = currentDate.toLocaleDateString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });

      const dayData = {
        date: dateStr,
        columns: [
          // Все ячейки заполняем 'М' (зелёные) как требовалось
          { headerId: "station1", value: "М" },
          { headerId: "station2", value: "М" },
          { headerId: "station3", value: "М" },
          { headerId: "station4", value: "М" },
          { headerId: "station5", value: "М" }
        ]
      };

      data.push(dayData);
    }

    console.log(`[ASYNC DP] Возвращено ${data.length} записей в новом формате`);
    return { data };
  };

  // 3. Async обработчик кликов
  window.onTableCellClick = async function(cellData) {
    console.log(`[ASYNC КЛИК] Обрабатываем клик: ${cellData.date} / ${cellData.nodeId}`);

    try {
      // Имитация async обработки
      await new Promise(resolve => setTimeout(resolve, 300));

      console.log(`[ASYNC КЛИК] Обработано: Дата=${cellData.date}, ID=${cellData.nodeId}, Значение=${cellData.value}`);

      // Здесь может быть ваша бизнес-логика
      const result = {
        processed: true,
        timestamp: new Date().toISOString(),
        cellInfo: cellData
      };

      console.log('[ASYNC КЛИК] Результат обработки:', result);
      return result;

    } catch (error) {
      console.error('[ASYNC КЛИК] Ошибка:', error);
      throw error;
    }
  };

  // Загрузка компонента
  const script = document.createElement('script');
  script.src = '../dist/virtualized-table.js';

  script.onload = function() {
    setTimeout(() => {
      if (customElements.get('virtualized-table')) {
        console.log('[HTML] ✅ Async компонент загружен успешно');

        // Тест async провайдеров
        Promise.all([
          window.hp().then(headers => {
            console.log('[TEST] HP тест пройден:', headers.headers.length, 'заголовков');
            return headers;
          }),
          window.dp('01.01.2024', 'forward', 3).then(data => {
            console.log('[TEST] DP тест пройден:', data.data.length, 'записей');
            return data;
          })
        ]).then(([headers, data]) => {
          console.log('[TEST] ✅ Все async провайдеры работают корректно');
        }).catch(error => {
          console.error('[TEST] ❌ Ошибка в async провайдерах:', error);
        });

      } else {
        console.error('[HTML] ❌ Компонент не зарегистрирован');
      }
    }, 500);
  };

  script.onerror = function() {
    console.error('[HTML] ❌ Ошибка загрузки компонента');
  };

  document.head.appendChild(script);
</script>

<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background-color: #f5f5f5;
  }
  h1 {
    color: #333;
    margin-bottom: 20px;
  }
  virtualized-table {
    background: white;
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
</style>
</body>
</html>